import numpy as np


class Orthographizer(object):

    def __init__(self, max_length=10):
        """
        An orthographic vectorizer which vectorizes according to the 17-segment
        display, commonly found on a microwave or other cheap electronic devices.

        See Wikipedia:

        :param max_length: The maximum length of words in characters
        :return:
        """

        self.binarizer = {"A1": 0, "A2": 1, "F": 2, "H": 3, "I": 4, "J": 5, "B": 6, "G1": 7, "G2": 8,
                          "E": 9, "K": 10, "L": 11, "M": 12, "C": 13, "D1": 14, "D2": 15, "DP": 16}

        super().__init__()

        self.maxlen = max_length

        # Features
        self.orth = {"◰": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'I'],
                     "◱": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'L'],
                     "◲": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G2', 'L'],
                     "◳": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G2', 'I'],
                     "◫": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'I', 'L'],
                     "◨": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G2', 'I', 'J', 'L', 'M'],
                     "◧": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'H', 'I', 'K', 'L'],
                     "◩": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'H', 'I', 'J', 'K'],
                     "◪": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G2', 'J', 'K', 'L', 'M'],
                     "⬒": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'K', 'L', 'M'],
                     "⬓": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'H', 'I', 'J'],
                     "◿": ['B', 'C', 'D1', 'D2', 'J', 'K'],
                     "▪": ['D1', 'D2', 'E', 'F', 'H', 'M'],
                     "◸": ['A1', 'A2', 'E', 'F', 'J', 'K'],
                     "◹": ['A1', 'A2', 'B', 'C', 'H', 'M'],
                     "▶": ['E', 'F', 'G1', 'H', 'K'],
                     "◀": ['B', 'C', 'G2', 'J', 'M'],
                     "↕": ['H', 'I', 'J', 'K', 'L', 'M'],
                     "‼": ['B', 'C', 'I', 'L', 'DP'],
                     "¶": ['A1', 'A2', 'B', 'C', 'F', 'G1', 'G2', 'I', 'L'],
                     "§": ['A1', 'A2', 'C', 'D1', 'D2', 'F', 'G1', 'G2', 'H', 'M'],
                     "▬": ['C', 'D1', 'D2', 'E', 'G1', 'G2', 'K', 'L', 'M'],
                     "↨": ['D1', 'D2', 'H', 'I', 'J', 'K', 'L', 'M'],
                     "↑": ['K', 'L', 'M'],
                     "↓": ['H', 'I', 'J'],
                     "→": ['G1', 'H', 'K'],
                     "←": ['G2', 'J', 'M'],
                     "∟": ['D1', 'D2', 'E'],
                     "↔": ['G1', 'G2', 'H', 'J', 'K', 'M'],
                     "▲": ['D1', 'D2', 'K', 'L', 'M'],
                     "▼": ['A1', 'A2', 'H', 'I', 'J'],
                     " ": [],
                     "!": ['B', 'C', 'DP'],
                     "'": ['B', 'F'],
                     "#": ['D1', 'D2', 'E', 'F', 'G1', 'G2', 'I', 'L'],
                     "$": ['A1', 'A2', 'C', 'D1', 'D2', 'F', 'G1', 'G2', 'I', 'L'],
                     "%": ['A1', 'C', 'D2', 'F', 'G1', 'G2', 'I', 'J', 'K', 'L'],
                     "&": ['A1', 'D1', 'D2', 'E', 'F', 'G1', 'H', 'J', 'M'],
                     '"': ['B'],
                     "(": ['J', 'M'],
                     ")": ['H', 'K'],
                     "*": ['G1', 'G2', 'H', 'I', 'J', 'K', 'L', 'M'],
                     "+": ['G1', 'G2', 'I', 'L'],
                     ", ": ['D1'],
                     "-": ['G1', 'G2'],
                     ".": ['DP'],
                     "/": ['J', 'K'],
                     "0": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'J', 'K'],
                     "1": ['B', 'C'],
                     "2": ['A1', 'A2', 'B', 'D1', 'D2', 'E', 'G1', 'G2'],
                     "3": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'G1', 'G2'],
                     "4": ['B', 'C', 'F', 'G1', 'G2'],
                     "5": ['A1', 'A2', 'C', 'D1', 'D2', 'F', 'G1', 'G2'],
                     "6": ['A1', 'A2', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2'],
                     "7": ['A1', 'A2', 'B', 'C'],
                     "8": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2'],
                     "9": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'F', 'G1', 'G2'],
                     ":": ['G1', 'D1'],
                     ";": ['A1', 'K'],
                     "<": ['J', 'M'],
                     "=": ['D1', 'D2', 'G1', 'G2'],
                     ">": ['H', 'K'],
                     "?": ['A2', 'B', 'G2', 'L', 'DP'],
                     "@": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'G1', 'L'],
                     "A": ['A1', 'A2', 'B', 'C', 'E', 'F', 'G1', 'G2'],
                     "B": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'G2', 'I', 'L'],
                     "C": ['A1', 'A2', 'D1', 'D2', 'E', 'F'],
                     "D": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'I', 'L'],
                     "E": ['A1', 'A2', 'D1', 'D2', 'E', 'F', 'G1'],
                     "F": ['A1', 'A2', 'E', 'F', 'G1'],
                     "G": ['A1', 'A2', 'C', 'D1', 'D2', 'E', 'F', 'G2'],
                     "H": ['B', 'C', 'E', 'F', 'G1', 'G2'],
                     "I": ['A1', 'A2', 'D1', 'D2', 'I', 'L'],
                     "J": ['B', 'C', 'D1', 'D2', 'E'],
                     "K": ['E', 'F', 'G1', 'J', 'M'],
                     "L": ['D1', 'D2', 'E', 'F'],
                     "M": ['B', 'C', 'E', 'F', 'H', 'J'],
                     "N": ['B', 'C', 'E', 'F', 'H', 'M'],
                     "O": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F'],
                     "P": ['A1', 'A2', 'B', 'E', 'F', 'G1', 'G2'],
                     "Q": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'M'],
                     "R": ['A1', 'A2', 'B', 'E', 'F', 'G1', 'G2', 'M'],
                     "S": ['A1', 'A2', 'C', 'D1', 'D2', 'F', 'G1', 'G2'],
                     "T": ['A1', 'A2', 'I', 'L'],
                     "U": ['B', 'C', 'D1', 'D2', 'E', 'F'],
                     "V": ['E', 'F', 'J', 'K'],
                     "W": ['B', 'C', 'E', 'F', 'K', 'M'],
                     "X": ['H', 'J', 'K', 'M'],
                     "Y": ['H', 'J', 'L'],
                     "Z": ['A1', 'A2', 'D1', 'D2', 'J', 'K'],
                     "[": ['A2', 'D2', 'I', 'L'],
                     "\\": ['H', 'M'],
                     "]": ['A1', 'D1', 'I', 'L'],
                     "^": ['K', 'M'],
                     "_": ['D1', 'D2'],
                     "`": ['H'],
                     "a": ['D1', 'D2', 'E', 'G1', 'L'],
                     "b": ['C', 'D1', 'D2', 'E', 'F', 'G1', 'G2'],
                     "c": ['D1', 'D2', 'E', 'G1', 'G2'],
                     "d": ['B', 'C', 'D1', 'D2', 'E', 'G1', 'G2'],
                     "e": ['D1', 'D2', 'E', 'G1', 'K'],
                     "f": ['A2', 'G1', 'G2', 'I', 'L'],
                     "g": ['D2', 'E', 'G1', 'K', 'M'],
                     "h": ['C', 'E', 'F', 'G1', 'G2'],
                     "i": ['A1', 'D1', 'D2', 'G1', 'L'],
                     "j": ['A2', 'C', 'D1', 'D2', 'G2'],
                     "k": ['E', 'F', 'G1', 'G2', 'M'],
                     "l": ['A1', 'D2', 'I', 'L'],
                     "m": ['C', 'E', 'G1', 'G2', 'L'],
                     "n": ['C', 'E', 'G1', 'G2'],
                     "o": ['C', 'D1', 'D2', 'E', 'G1', 'G2'],
                     "p": ['C', 'D1', 'G2', 'L', 'M'],
                     "q": ['C', 'D1', 'D2', 'E', 'G1', 'G2', 'M'],
                     "r": ['E', 'G1', 'G2'],
                     "s": ['D1', 'D2', 'G2', 'M'],
                     "t": ['D2', 'G1', 'G2', 'I', 'L'],
                     "u": ['C', 'D1', 'D2', 'E'],
                     "v": ['E', 'K'],
                     "w": ['C', 'E', 'K', 'M'],
                     "x": ['G1', 'G2', 'K', 'M'],
                     "y": ['C', 'D1', 'D2', 'M'],
                     "z": ['D1', 'G1', 'K'],
                     "{": ['A2', 'D2', 'G1', 'I', 'L'],
                     "|": ['I', 'L'],
                     "}": ['A1', 'D1', 'G2', 'I', 'L'],
                     "~": ['F', 'H', 'J'],
                     "⌂": ['D1', 'D2', 'K', 'M'],
                     "̈": ['C', 'E'],
                     "æ": ['A2', 'B', 'D1', 'E', 'G1', 'G2', 'H', 'I', 'L', 'M'],
                     "⧖": ['A1', 'A2', 'D1', 'D2', 'H', 'I', 'J', 'K', 'M'],
                     "⧗": ['A1', 'A2', 'D1', 'D2', 'H', 'J', 'K', 'L', 'M'],
                     "€": ['A1', 'D1', 'E', 'F', 'G1', 'J', 'M'],
                     "“": ['C', 'L'],
                     "”": ['F', 'I'],
                     "´": ['J'],
                     "Æ": ['A1', 'A2', 'D2', 'E', 'F', 'G1', 'G2', 'I', 'L'],
                     "⌐": ['A1', 'A2', 'F'],
                     "¬": ['A1', 'A2', 'B'],
                     "¢": ['A1', 'A2', 'D1', 'D2', 'E', 'F', 'I', 'L'],
                     "£": ['A2', 'D1', 'D2', 'G1', 'G2', 'I', 'L'],
                     "¥": ['G1', 'G2', 'H', 'J', 'L'],
                     "₧": ['A1', 'D2', 'E', 'F', 'G1', 'G2', 'I', 'L', 'M'],
                     "ƒ": ['A2', 'D1', 'G1', 'G2', 'I', 'L'],
                     "▖": ['D1', 'E', 'G1', 'K', 'L'],
                     "▗": ['C', 'D2', 'G2', 'L', 'M'],
                     "▘": ['A1', 'F', 'G1', 'H', 'I'],
                     "▙": ['A1', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'H', 'I', 'K', 'L', 'M'],
                     "▚": ['A1', 'C', 'D2', 'F', 'G1', 'G2', 'H', 'I', 'L', 'M'],
                     "▛": ['A1', 'A2', 'B', 'D1', 'E', 'F', 'G1', 'G2', 'H', 'I', 'J', 'K', 'L'],
                     "▜": ['A1', 'A2', 'B', 'C', 'D2', 'F', 'G1', 'G2', 'H', 'I', 'J', 'L', 'M'],
                     "▝": ['A2', 'B', 'G2', 'I', 'J'],
                     "▞": ['A2', 'B', 'D1', 'E', 'G1', 'I', 'G2', 'J', 'K', 'L'],
                     "▟": ['A2', 'B', 'C', 'D1', 'D2', 'E', 'G1', 'G2', 'I', 'J', 'K', 'L', 'M'],
                     "▤": ['A1', 'A2', 'D1', 'D2', 'G1', 'G2'],
                     "▵": ['B', 'C', 'E', 'F', 'I', 'L'],
                     "▦": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'I', 'L'],
                     "▧": ['A2', 'B', 'D1', 'E', 'H', 'M'],
                     "▨": ['A1', 'C', 'D2', 'F', 'J', 'K'],
                     "▩": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'H', 'J', 'K', 'M'],
                     "░": ['A2', 'D1', 'H', 'J', 'K', 'M'],
                     "▒": ['A1', 'A2', 'D1', 'D2', 'G1', 'G2', 'H', 'J', 'K', 'M'],
                     "▓": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'H', 'J', 'K', 'M'],
                     "│": ['I', 'L'],
                     "┤": ['G1', 'I', 'L'],
                     "╡": ['A1', 'G1', 'I', 'L'],
                     "╢": ['B', 'C', 'E', 'F', 'G1'],
                     "╖": ['C', 'G1', 'G2', 'E'],
                     "╕": ['A1', 'G1', 'I', 'L'],
                     "╣": ['B', 'C', 'E'],
                     "║": ['B', 'C', 'E', 'F'],
                     "╗": ['A1', 'A2', 'B', 'C', 'E'],
                     "╝": ['B', 'G1', 'G2'],
                     "╜": ['B', 'G1', 'F', 'G2'],
                     "╛": ['A1', 'G1', 'I'],
                     "┐": ['G1', 'L'],
                     "└": ['G2', 'I'],
                     "┴": ['G1', 'G2', 'I'],
                     "┬": ['G1', 'G2', 'L'],
                     "├": ['G2', 'I', 'L'],
                     "─": ['G1', 'G2'],
                     "┼": ['G1', 'G2', 'I', 'L'],
                     "╞": ['A2', 'G2', 'I', 'L'],
                     "╟": ['B', 'C', 'E', 'F', 'G2'],
                     "╚": ['F', 'G1', 'G2'],
                     "╔": ['A1', 'A2', 'C', 'E', 'F'],
                     "╩": ['G1', 'G2'],
                     "╦": ['A1', 'A2', 'C', 'E'],
                     "╠": ['C', 'E', 'F'],
                     "═": ['A1', 'A2', 'G1', 'G2'],
                     "╬": ['C', 'E'],
                     "╧": ['A1', 'A2', 'G1', 'G2', 'I'],
                     "╨": ['B', 'F', 'G1', 'G2'],
                     "╤": ['A1', 'A2', 'G1', 'G2', 'L'],
                     "╥": ['C', 'E', 'G1', 'G2'],
                     "╙": ['B', 'F', 'G1', 'G2'],
                     "╘": ['A2', 'G2', 'I'],
                     "╒": ['A2', 'G2', 'I', 'L'],
                     "╓": ['C', 'E', 'G1', 'G2'],
                     "╫": ['B', 'C', 'E', 'F', 'G1', 'G2'],
                     "╪": ['A1', 'A2', 'G1', 'G2', 'I', 'L'],
                     "┘": ['G1', 'I'],
                     "┌": ['G2', 'L'],
                     "█": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'H', 'I', 'J', 'K', 'L', 'M'],
                     "▄": ['C', 'D1', 'D2', 'E', 'G1', 'G2', 'K', 'L', 'M'],
                     "▌": ['A1', 'D1', 'E', 'F', 'G1', 'H', 'I', 'K', 'L'],
                     "▐": ['A2', 'B', 'C', 'D2', 'G2', 'I', 'J', 'L', 'M'],
                     "▀": ['A1', 'A2', 'B', 'F', 'G1', 'G2', 'H', 'I', 'J'],
                     "α": ['A1', 'D1', 'E', 'F', 'I', 'J', 'L', 'M'],
                     "ß": ['A2', 'B', 'C', 'D2', 'G2', 'I', 'K'],
                     "Γ": ['A1', 'A2', 'E', 'F'],
                     "π": ['G1', 'G2', 'K', 'M'],
                     "Σ": ['A1', 'A2', 'D1', 'D2', 'H', 'K'],
                     "σ": ['D1', 'E', 'G1', 'G2', 'L'],
                     "µ": ['B', 'E', 'F', 'G1', 'G2'],
                     "τ": ['A1', 'A2', 'I', 'M'],
                     "Φ": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'I', 'L'],
                     "Θ": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2'],
                     "Ω": ['A1', 'A2', 'G1', 'G2', 'H', 'J'],
                     "δ": ['A1', 'A2', 'C', 'D1', 'D2', 'E', 'G1', 'G2', 'H'],
                     "∞": ['B', 'C', 'E', 'F', 'H', 'J', 'K', 'M'],
                     "φ": ['A2', 'B', 'F', 'G1', 'G2', 'I', 'L'],
                     "ε": ['A1', 'D1', 'E', 'F', 'G1'],
                     "Π": ['A1', 'A2', 'B', 'C', 'E', 'F'],
                     "≡": ['A1', 'A2', 'D1', 'D2', 'G1', 'G2'],
                     "±": ['D1', 'D2', 'G1', 'G2', 'I', 'L'],
                     "≥": ['D1', 'D2', 'H', 'K'],
                     "≤": ['D1', 'D2', 'J', 'M'],
                     "⌠": ['A1', 'E', 'F', 'I'],
                     "⌡": ['B', 'C', 'D2', 'L'],
                     "÷": ['A2', 'D2', 'G1', 'G2'],
                     "≈": ['C', 'F', 'H', 'J', 'K', 'M'],
                     "°": ['A2', 'B', 'G2', 'I'],
                     "√": ['A2', 'B', 'I'],
                     "ⁿ": ['A2', 'G2', 'J'],
                     "²": ['E', 'G2', 'K'],
                     "▣": ['A1', 'A2', 'B', 'C', 'D1', 'D2', 'E', 'F', 'G1', 'G2', 'H', 'I', 'J', 'K', 'L', 'M', 'DP']}

        self.data = {k: self._convert_bin(v) for k, v in self.orth.items()}

    def _convert_bin(self, coordinates):
        """
        Convert the numerical coordinates, given above, to a
        binary format.

        :param coordinates: A list of numerical coordinates.
        :return: A flat numpy array, representing the  converted form.
        """

        d = np.zeros((len(self.binarizer),))
        for c in coordinates:
            d[self.binarizer[c]] += 1

        return d

    def check(self, x):
        """
        Check whether no illegal characters occur.

        :param x: The string to check
        :return: A boolean
        """

        return not set(x).difference(self.data.keys())

    def vectorize_single(self, word):
        """
        Vectorize a single word.

        Raises a ValueError if the word is too long.

        :param word: A string of characters
        :return: A numpy array, representing the concatenated letter representations.
        """

        if len(word) > self.maxlen:
            raise ValueError("Too long")

        x = np.zeros((self.maxlen * len(self.binarizer),))
        for idx, c in enumerate(word):
            curr = idx * len(self.binarizer)
            x[curr: curr + len(self.binarizer)] += self.data[c]

        return x

    def vectorize(self, data):
        """
        Vectorize an entire corpus.

        :param data: A list of words.
        :return: A numpy array
        """

        X = []

        for word in data:

            try:
                X.append(self.vectorize_single(word))
            except (KeyError, ValueError):
                continue

        return np.array(X)
